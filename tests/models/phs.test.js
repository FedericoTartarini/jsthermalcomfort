import { expect, describe, it } from "@jest/globals";
import { deep_close_to_obj } from "../test_utilities";
import { phs } from "../../src/models/phs";

describe("phs", () => {
  it("should be a function", () => {
    expect(phs).toBeInstanceOf(Function);
  });

  it.each([
    {
      tdb: 40,
      tr: 40,
      v: 0.3,
      rh: 33.85,
      met: 150,
      clo: 0.5,
      posture: 2,
      wme: undefined,
      kwargs: undefined,
      expected: {
        d_lim_loss_50: 440.0,
        d_lim_loss_95: 298.0,
        d_lim_t_re: 480.0,
        water_loss: 6166.4,
        t_re: 37.5,
        t_cr: 37.5,
        t_sk: 35.3,
        t_cr_eq: 37.1,
        t_sk_t_cr_wg: 0.24,
        water_loss_watt: 266.1,
      },
    },
    {
      tdb: 35,
      tr: 35,
      v: 0.3,
      rh: 71,
      met: 150,
      clo: 0.5,
      posture: 2,
      wme: undefined,
      kwargs: undefined,
      expected: {
        d_lim_loss_50: 385.0,
        d_lim_loss_95: 256.0,
        d_lim_t_re: 75.0,
        water_loss: 6934.6,
        t_re: 39.8,
        t_cr: 39.7,
        t_sk: 36.4,
        t_cr_eq: 37.1,
        t_sk_t_cr_wg: 0.1,
        water_loss_watt: 276.9,
      },
    },
    {
      tdb: 30,
      tr: 50,
      v: 0.3,
      rh: 70.65,
      met: 150,
      clo: 0.5,
      posture: 2,
      wme: undefined,
      kwargs: undefined,
      expected: {
        d_lim_loss_50: 380.0,
        d_lim_loss_95: 258.0,
        d_lim_t_re: 480.0,
        water_loss: 7166.2,
        t_re: 37.7,
        t_cr: 37.7,
        t_sk: 35.7,
        t_cr_eq: 37.1,
        t_sk_t_cr_wg: 0.22,
        water_loss_watt: 312.5,
      },
    },
    {
      tdb: 28,
      tr: 58,
      v: 0.3,
      rh: 79.31,
      met: 150,
      clo: 0.5,
      posture: 2,
      wme: undefined,
      kwargs: { acclimatized: 0 },
      expected: {
        d_lim_loss_50: 466.0,
        d_lim_loss_95: 314.0,
        d_lim_t_re: 57.0,
        water_loss: 5807.3,
        t_re: 41.2,
        t_cr: 41.1,
        t_sk: 37.8,
        t_cr_eq: 37.1,
        t_sk_t_cr_wg: 0.1,
        water_loss_watt: 250.0,
      },
    },
    {
      tdb: 35,
      tr: 35,
      v: 1,
      rh: 53.3,
      met: 150,
      clo: 0.5,
      posture: 1,
      wme: undefined,
      kwargs: { acclimatized: 0 },
      expected: {
        d_lim_loss_50: 480.0,
        d_lim_loss_95: 463.0,
        d_lim_t_re: 480.0,
        water_loss: 3891.8,
        t_re: 37.6,
        t_cr: 37.5,
        t_sk: 34.8,
        t_cr_eq: 37.1,
        t_sk_t_cr_wg: 0.24,
        water_loss_watt: 165.7,
      },
    },
    {
      tdb: 43,
      tr: 43,
      v: 0.3,
      rh: 34.7,
      met: 103,
      clo: 0.5,
      posture: 1,
      wme: undefined,
      kwargs: undefined,
      expected: {
        d_lim_loss_50: 401.0,
        d_lim_loss_95: 271.0,
        d_lim_t_re: 480.0,
        water_loss: 6765.1,
        t_re: 37.3,
        t_cr: 37.2,
        t_sk: 35.3,
        t_cr_eq: 37.0,
        t_sk_t_cr_wg: 0.26,
        water_loss_watt: 293.6,
      },
    },
    {
      tdb: 35,
      tr: 35,
      v: 0.3,
      rh: 53.3,
      met: 206,
      clo: 0.5,
      posture: 2,
      wme: undefined,
      kwargs: { acclimatized: 0 },
      expected: {
        d_lim_loss_50: 372.0,
        d_lim_loss_95: 247.0,
        d_lim_t_re: 70.0,
        water_loss: 7235.9,
        t_re: 39.2,
        t_cr: 39.1,
        t_sk: 36.1,
        t_cr_eq: 37.3,
        t_sk_t_cr_wg: 0.1,
        water_loss_watt: 295.7,
      },
    },
    {
      tdb: 34,
      tr: 34,
      v: 0.3,
      rh: 56.3,
      met: 150,
      clo: 1,
      posture: 2,
      wme: undefined,
      kwargs: { acclimatized: 0 },
      expected: {
        d_lim_loss_50: 480.0,
        d_lim_loss_95: 318.0,
        d_lim_t_re: 67.0,
        water_loss: 5547.7,
        t_re: 41.0,
        t_cr: 40.9,
        t_sk: 36.7,
        t_cr_eq: 37.1,
        t_sk_t_cr_wg: 0.1,
        water_loss_watt: 213.9,
      },
    },
    {
      tdb: 40,
      tr: 40,
      v: 0.3,
      rh: 40.63,
      met: 150,
      clo: 0.4,
      posture: 2,
      wme: undefined,
      kwargs: undefined,
      expected: {
        d_lim_loss_50: 407.0,
        d_lim_loss_95: 276.0,
        d_lim_t_re: 480.0,
        water_loss: 6683.4,
        t_re: 37.5,
        t_cr: 37.4,
        t_sk: 35.5,
        t_cr_eq: 37.1,
        t_sk_t_cr_wg: 0.24,
        water_loss_watt: 290.4,
      },
    },
    {
      tdb: 40,
      tr: 40,
      v: 0.3,
      rh: 40.63,
      met: 150,
      clo: 0.4,
      posture: 2,
      wme: undefined,
      kwargs: { theta: 90, walk_sp: 1 },
      expected: {
        d_lim_loss_50: 480.0,
        d_lim_loss_95: 339.0,
        d_lim_t_re: 480.0,
        water_loss: 5379.1,
        t_re: 37.6,
        t_cr: 37.5,
        t_sk: 35.5,
        t_cr_eq: 37.1,
        t_sk_t_cr_wg: 0.24,
        water_loss_watt: 231.5,
      },
    },
  ])(
    "returns $expected when tdb is $tdb, tr is $tr, v is $v, rh is $rh, met is $met, " +
      "clo is $clo, posture is $posture, wme is $wme and kwargs is $kwargs",
    ({ expected, tdb, tr, v, rh, met, clo, posture, wme, kwargs }) => {
      const result = phs(tdb, tr, v, rh, met, clo, posture, wme, kwargs);
      deep_close_to_obj(result, expected, 1);
    },
  );
});
